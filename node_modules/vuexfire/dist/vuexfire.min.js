/**
 * vuexfire v3.0.0-alpha.5
 * (c) 2018 Eduardo San Martin Morote <posva13@gmail.com>
 * @license MIT
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.Vuexfire={})}(this,function(e){"use strict";function t(e){return Object.defineProperty(e.data(),"id",{value:e.id})}var n=function(e){return e&&"object"==typeof e},r=function(e){return e.toDate},o=function(e){return e&&e.onSnapshot};function i(e,t,a,c){void 0===a&&(a=""),void 0===c&&(c=[{},{}]),t=t||{};var u=Object.getOwnPropertyDescriptor(e,"id");return u&&!u.enumerable&&Object.defineProperty(c[0],"id",u),Object.keys(e).reduce(function(c,u){var f=e[u];return o(f)?(c[0][u]=t[u]||f.path,c[1][a+u]=f):Array.isArray(f)?(c[0][u]=Array(f.length).fill(null),i(f,t[u],a+u+".",[c[0][u],c[1]])):null==f||f instanceof Date||r(f)||f.longitude&&f.latitude?c[0][u]=f:n(f)?(c[0][u]={},i(f,t[u],a+u+".",[c[0][u],c[1]])):c[0][u]=f,c},c)}function a(e,t){return t.split(".").reduce(function(e,t){return e[t]},e)}var c,u="vuexfire/SET_VALUE",f="vuexfire/ARRAY_ADD",s="vuexfire/ARRAY_REMOVE",d=((c={})[u]=function(e,t){var n,r,o,i,a,c=t.path,u=t.target,f=t.data;n=u,r=f,o=(""+c).split("."),i=o.pop(),a=o.reduce(function(e,t){return e[t]},n),isFinite(i)?a.splice(i,1,r):a[i]=r},c[f]=function(e,t){var n=t.newIndex,r=t.data;t.target.splice(n,0,r)},c[s]=function(e,t){var n=t.oldIndex;return t.target.splice(n,1)[0]},c),l={},p={root:!0};function v(e){for(var t in e)e[t].unsub()}function m(e,n){var r=e.subs,o=e.refs,i=e.target,a=e.path,c=(e.data,e.depth),f=e.commit,s=e.resolve,d=Object.keys(o);if(Object.keys(r).filter(function(e){return d.indexOf(e)<0}).forEach(function(e){r[e].unsub(),delete r[e]}),!d.length||++c>n.maxRefDepth)return s(a);var l=0,m=d.length,b=Object.create(null);d.forEach(function(e){var d,g,y,x,j,O,k,A,I,w,E=r[e],R=o[e],D=a+"."+e;if(b[D]=!0,E){if(E.path===R.path)return;E.unsub()}r[e]={unsub:(d={ref:R,target:i,path:D,depth:c,commit:f,resolve:function(e){e in b&&++l>=m&&s(a)}.bind(null,D)},g=n,y=d.ref,x=d.target,j=d.path,O=d.depth,k=d.commit,A=d.resolve,I=Object.create(null),w=y.onSnapshot(function(e){e.exists?h({snapshot:t(e),target:x,path:j,subs:I,depth:O,commit:k,resolve:A},g):(k(u,{target:x,path:j,data:null},p),A(j))}),function(){w(),v(I)}),path:R.path}})}function h(e,t){var n=e.snapshot,r=e.target,o=e.path,c=e.subs,f=e.depth;void 0===f&&(f=0);var s=e.commit,d=e.resolve,l=i(n,a(r,o)),v=l[0],h=l[1];s(u,{path:o,target:r,data:v},p),m({data:v,subs:c,refs:h,target:r,path:o,depth:f,commit:s,resolve:d},t)}Object.keys(d).forEach(function(e){l[e]=function(t,n){d[e](n.state,n)}});var b=new WeakMap;function g(e,n){var r=e.state,o=e.commit,c=e.key,d=e.ref;void 0===n&&(n={maxRefDepth:2});var l=b.get(o);return l||(l=Object.create(null),b.set(o,l)),c in l&&y({commit:o,key:c}),new Promise(function(e,b){l[c]=d.where?function(e,n){var r=e.vm,o=e.key,c=e.collection,d=e.commit,l=e.resolve,h=e.reject;d(u,{path:o,target:r,data:[]},p);var b,g=a(r,o),y=l,x=[],j={added:function(e){var r=e.newIndex,o=e.doc;x.splice(r,0,Object.create(null));var a=x[r],c=i(t(o)),u=c[0],s=c[1];d(f,{target:g,newIndex:r,data:u},p),m({data:u,refs:s,subs:a,target:g,path:r,depth:0,commit:d,resolve:l.bind(null,o)},n)},modified:function(e){var r=e.oldIndex,o=e.newIndex,a=e.doc,c=x.splice(r,1)[0];x.splice(o,0,c);var u=d(s,{target:g,oldIndex:r},p),v=i(t(a),u),h=v[0],b=v[1];d(f,{target:g,newIndex:o,data:h},p),m({data:h,refs:b,subs:c,target:g,path:o,depth:0,commit:d,resolve:l},n)},removed:function(e){var t=e.oldIndex;d(s,{target:g,oldIndex:t},p),v(x.splice(t,1)[0])}},O=c.onSnapshot(function(e){var t="function"==typeof e.docChanges?e.docChanges():e.docChanges;if(!b&&t.length){b=!0;var n=0,i=t.length,a=t.reduce(function(e,t){return e[t.doc.id]=!1,e},Object.create(null));l=function(e){e.id in a&&++n>=i&&(y(r[o]),l=function(e){})}}t.forEach(function(e){j[e.type](e)}),t.length||l()},h);return function(){O(),x.forEach(v)}}({vm:r,key:c,collection:d,commit:o,resolve:e,reject:b},n):function(e,n){var r,o,i,a=e.vm,c=e.key,u=e.document,f=e.commit,s=e.resolve,d=e.reject,l=Object.create(null);r=s,o=function(){return a[c]},s=function(){if(!i)return i=!0,r(o())};var p=u.onSnapshot(function(e){e.exists?h({snapshot:t(e),target:a,path:c,subs:l,commit:f,resolve:s},n):s()},d);return function(){p(),v(l)}}({vm:r,key:c,document:d,commit:o,resolve:e,reject:b},n)})}function y(e){var t=e.commit,n=e.key,r=b.get(t);r&&(r[n](),delete r[n])}e.firebaseMutations=l,e.firebaseAction=function(e){return function(t,n){var r=t.state,o=t.commit;return t.bindFirebaseRef=function(e,t,n){return void 0===n&&(n={}),g({state:r,commit:o,key:e,ref:t},n)},t.unbindFirebaseRef=function(e){return y({commit:o,key:e})},e(t,n)}},Object.defineProperty(e,"__esModule",{value:!0})});